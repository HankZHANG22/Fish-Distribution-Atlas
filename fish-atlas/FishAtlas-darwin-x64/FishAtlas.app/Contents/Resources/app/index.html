<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global Fish Distribution Atlas</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        :root {
            --ocean-deep: #0a1628;
            --ocean-mid: #1a3a5c;
            --ocean-light: #2d5a87;
            --freshwater: #2ecc71;
            --freshwater-light: rgba(46, 204, 113, 0.5);
            --freshwater-glow: rgba(46, 204, 113, 0.3);
            --saltwater: #3498db;
            --saltwater-light: rgba(52, 152, 219, 0.5);
            --saltwater-glow: rgba(52, 152, 219, 0.3);
            --sand: #f4e4c1;
            --coral: #ff6b6b;
            --foam: rgba(255, 255, 255, 0.97);
            --text-dark: #1a1a2e;
            --text-light: #e8e8e8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--ocean-deep);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            padding: 1rem 2rem;
            background: linear-gradient(180deg, rgba(10, 22, 40, 0.95) 0%, rgba(10, 22, 40, 0) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 48px; height: 48px; }
        .logo-icon svg { width: 100%; height: 100%; }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            background: linear-gradient(135deg, var(--sand) 0%, var(--foam) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--ocean-light);
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        /* Controls */
        .filter-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid transparent;
            border-radius: 50px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        .filter-btn:hover::before { width: 200%; height: 200%; }

        /* View controls */
        .view-controls { display: flex; gap: 0.6rem; align-items: center; }
        .type-controls { display: flex; gap: 0.75rem; align-items: center; }

        .filter-btn.view {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(244, 228, 193, 0.5);
            color: var(--sand);
        }
        .filter-btn.view.active {
            background: var(--sand);
            color: var(--ocean-deep);
        }

        /* Type filter styles */
        .filter-btn.all {
            background: linear-gradient(135deg, var(--ocean-mid) 0%, var(--ocean-deep) 100%);
            border-color: var(--sand);
            color: var(--sand);
        }
        .filter-btn.all.active { background: var(--sand); color: var(--ocean-deep); }

        .filter-btn.freshwater {
            background: transparent;
            border-color: var(--freshwater);
            color: var(--freshwater);
        }
        .filter-btn.freshwater.active {
            background: var(--freshwater);
            color: var(--ocean-deep);
            box-shadow: 0 0 20px var(--freshwater-glow);
        }

        .filter-btn.saltwater {
            background: transparent;
            border-color: var(--saltwater);
            color: var(--saltwater);
        }
        .filter-btn.saltwater.active {
            background: var(--saltwater);
            color: var(--ocean-deep);
            box-shadow: 0 0 20px var(--saltwater-glow);
        }

        /* Map */
        #map { width: 100%; height: 100vh; }

        /* Fish Selection Panel */
        .fish-list-panel {
            position: fixed;
            top: 80px;
            left: 1.5rem;
            width: 280px;
            max-height: calc(100vh - 180px);
            background: rgba(10, 22, 40, 0.92);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .fish-list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .fish-list-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--sand);
            margin-bottom: 0.75rem;
        }
        .fish-search {
            width: 100%;
            padding: 0.6rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .fish-search:focus { border-color: var(--saltwater); background: rgba(255, 255, 255, 0.08); }
        .fish-search::placeholder { color: rgba(255, 255, 255, 0.4); }

        .fish-list-content { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .fish-list-content::-webkit-scrollbar { width: 6px; }
        .fish-list-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .fish-list-content::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

        .fish-item {
            padding: 0.85rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 0.35rem;
            border: 1px solid transparent;
        }
        .fish-item:hover { background: rgba(255, 255, 255, 0.08); }
        .fish-item.active { background: rgba(255, 255, 255, 0.12); border-color: rgba(255, 255, 255, 0.2); }
        .fish-item.freshwater.active { border-color: var(--freshwater); background: rgba(46, 204, 113, 0.15); }
        .fish-item.saltwater.active { border-color: var(--saltwater); background: rgba(52, 152, 219, 0.15); }

        .fish-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .fish-item-latin { font-size: 0.8rem; font-style: italic; opacity: 0.6; }
        .fish-type-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .fish-type-dot.freshwater { background: var(--freshwater); box-shadow: 0 0 6px var(--freshwater-glow); }
        .fish-type-dot.saltwater { background: var(--saltwater); box-shadow: 0 0 6px var(--saltwater-glow); }

        /* Side Panel (Right - Info) */
        .side-panel {
            position: fixed;
            top: 0; right: -500px;
            width: 500px;
            height: 100vh;
            background: var(--foam);
            color: var(--text-dark);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
        }
        .side-panel.open { right: 0; }

        .panel-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--ocean-mid) 0%, var(--ocean-deep) 100%);
            color: var(--text-light);
            position: relative;
            overflow: hidden;
        }
        .panel-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath fill='rgba(255,255,255,0.05)' d='M0 10 Q25 0 50 10 T100 10 V20 H0Z'/%3E%3C/svg%3E") repeat-x;
            background-size: 100px 20px;
            animation: wave 8s linear infinite;
        }
        @keyframes wave { from { background-position-x: 0; } to { background-position-x: 100px; } }

        .panel-close {
            position: absolute;
            top: 1rem; right: 1rem;
            width: 40px; height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1;
        }
        .panel-close:hover { background: rgba(255, 255, 255, 0.2); transform: rotate(90deg); }

        .fish-type-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        .fish-type-badge.freshwater { background: var(--freshwater); color: var(--ocean-deep); }
        .fish-type-badge.saltwater { background: var(--saltwater); color: var(--ocean-deep); }

        .fish-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            position: relative;
            z-index: 1;
        }
        .fish-latin { font-style: italic; opacity: 0.7; font-size: 1rem; position: relative; z-index: 1; }

        .panel-content { flex: 1; overflow-y: auto; padding: 2rem; }

        /* Markdown Styles */
        .panel-content h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--ocean-deep);
            border-bottom: 3px solid var(--ocean-light);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .panel-content h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--ocean-mid);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .panel-content h2::before { content: '‚óÜ'; color: var(--coral); font-size: 0.8rem; }
        .panel-content p { line-height: 1.8; margin-bottom: 1rem; color: #444; }
        .panel-content ul, .panel-content ol { padding-left: 1.5rem; margin-bottom: 1rem; }
        .panel-content li { line-height: 1.8; margin-bottom: 0.5rem; color: #444; }
        .panel-content strong { color: var(--ocean-deep); }
        .panel-content blockquote {
            border-left: 4px solid var(--ocean-light);
            padding: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #666;
            background: rgba(45, 90, 135, 0.05);
            border-radius: 0 8px 8px 0;
        }
        .panel-content code {
            background: rgba(45, 90, 135, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        .panel-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .panel-content img:hover { transform: scale(1.02); }
        .panel-content hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(45, 90, 135, 0.3), transparent);
            margin: 1.5rem 0;
        }

        .panel-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .panel-content th {
            background: linear-gradient(135deg, var(--ocean-mid) 0%, var(--ocean-light) 100%);
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }
        .panel-content td {
            padding: 0.65rem 0.75rem;
            border-bottom: 1px solid rgba(45, 90, 135, 0.1);
            background: rgba(255, 255, 255, 0.5);
        }
        .panel-content tr:nth-child(even) td { background: rgba(45, 90, 135, 0.03); }
        .panel-content tr:hover td { background: rgba(45, 90, 135, 0.08); }

        /* Image modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .image-modal.active { display: flex; }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* Distribution info */
        .distribution-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(45, 90, 135, 0.08);
            border-radius: 10px;
        }
        .distribution-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--ocean-mid);
            margin-bottom: 0.75rem;
        }
        .distribution-countries { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .country-tag {
            padding: 0.3rem 0.6rem;
            background: var(--ocean-light);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 22, 40, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 150;
            backdrop-filter: blur(4px);
        }
        .overlay.active { opacity: 1; visibility: visible; }

        /* Stats Bar */
        .stats-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 22, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 50px;
            display: flex;
            gap: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        .stat-item { display: flex; align-items: center; gap: 0.5rem; }
        .stat-dot { width: 12px; height: 12px; border-radius: 50%; }
        .stat-dot.freshwater { background: var(--freshwater); box-shadow: 0 0 10px var(--freshwater-glow); }
        .stat-dot.saltwater { background: var(--saltwater); box-shadow: 0 0 10px var(--saltwater-glow); }
        .stat-label { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-light); }
        .stat-count { font-weight: 700; color: var(--sand); }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            background: rgba(10, 22, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        .legend-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--sand);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }
        .legend-item { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .legend-marker { width: 24px; height: 16px; border-radius: 3px; }
        .legend-marker.freshwater { background: var(--freshwater-light); border: 2px solid var(--freshwater); }
        .legend-marker.saltwater { background: var(--saltwater-light); border: 2px solid var(--saltwater); }
        .legend-label { font-size: 0.85rem; color: var(--text-light); }

        /* Mapbox overrides */
        .mapboxgl-ctrl-group {
            background: rgba(10, 22, 40, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        .mapboxgl-ctrl-group button { background-color: transparent !important; }
        .mapboxgl-ctrl-group button:hover { background-color: rgba(255, 255, 255, 0.1) !important; }
        .mapboxgl-ctrl-icon { filter: invert(1); }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--saltwater);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-light); }
        .error-message { text-align: center; color: #ff6b6b; }
        .error-message .icon { font-size: 3rem; margin-bottom: 1rem; }
        .error-message .text { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }
        .error-message .subtext { opacity: 0.7; font-size: 0.8rem; margin-top: 0.5rem; }

        /* No selection */
        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }
        .no-selection-icon { font-size: 3rem; margin-bottom: 1rem; }
        .no-selection-text { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }

        /* ===== Near Me Panel ===== */
        .near-me-panel {
            position: fixed;
            top: 80px;
            left: 1.5rem;
            width: 360px;
            max-height: calc(100vh - 180px);
            background: rgba(10, 22, 40, 0.92);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 120;
            display: none;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }
        .near-me-panel.active { display: flex; flex-direction: column; }

        .near-me-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .near-me-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--sand);
            margin-bottom: 0.15rem;
        }
        .near-me-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.55);
        }

        .near-me-refresh {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 1.1rem;
        }
        .near-me-refresh:hover { background: rgba(255,255,255,0.12); transform: rotate(90deg); }

        .near-me-body { padding: 1rem 1.25rem; overflow-y: auto; }
        .near-me-body::-webkit-scrollbar { width: 6px; }
        .near-me-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .near-me-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: rgba(244, 228, 193, 0.85);
            margin: 0.75rem 0 0.5rem;
        }

        .near-me-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 12px;
            padding: 0.85rem 0.9rem;
            margin-bottom: 0.75rem;
        }

        .near-me-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }
        .near-me-kv { display: flex; flex-direction: column; gap: 0.25rem; }
        .near-me-k {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .near-me-v {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--sand);
        }

        .near-me-fish-list { display: flex; flex-direction: column; gap: 0.4rem; }
        .near-me-fish-item {
            padding: 0.65rem 0.75rem;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .near-me-fish-item:hover { background: rgba(255,255,255,0.08); transform: translateY(-1px); }
        .near-me-fish-name { font-weight: 700; font-size: 0.92rem; display: flex; align-items: center; gap: 0.5rem; }
        .near-me-fish-latin { font-size: 0.78rem; font-style: italic; opacity: 0.65; margin-top: 0.1rem; }

        .near-me-pill {
            display: inline-block;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .near-me-pill.freshwater { color: var(--freshwater); border-color: rgba(46,204,113,0.35); }
        .near-me-pill.saltwater { color: var(--saltwater); border-color: rgba(52,152,219,0.35); }

        .near-me-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
            padding: 1.2rem 0;
            opacity: 0.9;
        }

        .near-me-footer {
            padding: 0.9rem 1.25rem 1.1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 0.6rem;
        }
        .near-me-input {
            flex: 1;
            padding: 0.55rem 0.75rem;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: var(--text-light);
            outline: none;
        }
        .near-me-input::placeholder { color: rgba(255,255,255,0.35); }
        .near-me-apply {
            padding: 0.55rem 0.9rem;
            border-radius: 10px;
            border: 1px solid rgba(244, 228, 193, 0.45);
            background: rgba(244, 228, 193, 0.12);
            color: var(--sand);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: 0.06em;
        }
        .near-me-apply:hover { background: rgba(244, 228, 193, 0.18); }

        /* Responsive */
        @media (max-width: 768px) {
            .side-panel { width: 100%; right: -100%; }

            .fish-list-panel, .near-me-panel {
                width: calc(100% - 3rem);
                left: 1.5rem;
                top: 140px;
                max-height: 240px;
            }

            .header { flex-direction: column; align-items: flex-start; padding: 1rem; }
            .filter-controls { width: 100%; justify-content: center; }

            .stats-bar { bottom: 1rem; padding: 0.75rem 1.5rem; gap: 1rem; }
            .legend { display: none; }
        }
    </style>
</head>

<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading map data...</div>
    </div>

    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 24C8 24 12 16 24 16C36 16 40 24 40 24C40 24 36 32 24 32C12 32 8 24 8 24Z" fill="url(#fishGrad)" stroke="#f4e4c1" stroke-width="2"/>
                    <circle cx="32" cy="24" r="3" fill="#0a1628"/>
                    <path d="M4 24L10 20V28L4 24Z" fill="url(#fishGrad)" stroke="#f4e4c1" stroke-width="1.5"/>
                    <path d="M24 20C24 20 26 22 26 24C26 26 24 28 24 28" stroke="#f4e4c1" stroke-width="1.5" stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="fishGrad" x1="4" y1="24" x2="40" y2="24">
                            <stop stop-color="#3498db"/>
                            <stop offset="1" stop-color="#2ecc71"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div>
                <div class="logo-text">Fish Distribution Atlas</div>
                <div class="logo-subtitle">Explore Global Species</div>
            </div>
        </div>

        <div class="filter-controls">
            <div class="view-controls">
                <button class="filter-btn view active" data-view="atlas">üó∫Ô∏è Atlas</button>
                <button class="filter-btn view" data-view="nearby">üìç Near Me</button>
            </div>

            <div class="type-controls" id="typeControls">
                <button class="filter-btn all active" data-filter="all">All</button>
                <button class="filter-btn freshwater" data-filter="freshwater">üåø Freshwater</button>
                <button class="filter-btn saltwater" data-filter="saltwater">üåä Saltwater</button>
            </div>
        </div>
    </header>

    <!-- Fish Selection Panel -->
    <div class="fish-list-panel">
        <div class="fish-list-header">
            <div class="fish-list-title">Select a Species</div>
            <input type="text" class="fish-search" id="fishSearch" placeholder="Search fish..." />
        </div>
        <div class="fish-list-content" id="fishListContent"></div>
    </div>

    <!-- Near Me Floating Island -->
    <div class="near-me-panel" id="nearMePanel">
        <div class="near-me-header">
            <div>
                <div class="near-me-title">Near Me</div>
                <div class="near-me-subtitle" id="nearMeSubtitle">Locating‚Ä¶</div>
            </div>
            <button class="near-me-refresh" id="nearMeRefresh" title="Refresh">‚Üª</button>
        </div>

        <div class="near-me-body" id="nearMeBody">
            <div class="near-me-loading">
                <div class="loading-spinner" style="width:32px;height:32px;"></div>
                <div class="loading-text" style="font-size:0.8rem;">Detecting location‚Ä¶</div>
            </div>
        </div>

        <div class="near-me-footer">
            <input class="near-me-input" id="manualCountryInput" placeholder="Or type a country (e.g., Japan)" />
            <button class="near-me-apply" id="manualCountryApply">Apply</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="overlay" id="overlay"></div>

    <!-- Image Modal for fullscreen view -->
    <div class="image-modal" id="imageModal">
        <img src="" alt="Fullscreen image" id="modalImage" />
    </div>

    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <button class="panel-close" id="panelClose">√ó</button>
            <span class="fish-type-badge" id="fishTypeBadge">Freshwater</span>
            <h2 class="fish-name" id="fishName">Fish Name</h2>
            <div class="fish-latin" id="fishLatin">Scientific Name</div>
        </div>
        <div class="panel-content" id="panelContent"></div>
    </div>

    <div class="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
            <div class="legend-marker freshwater"></div>
            <span class="legend-label">Freshwater</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker saltwater"></div>
            <span class="legend-label">Saltwater</span>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-dot freshwater"></div>
            <span class="stat-label">Freshwater: <span class="stat-count" id="freshwaterCount">0</span></span>
        </div>
        <div class="stat-item">
            <div class="stat-dot saltwater"></div>
            <span class="stat-label">Saltwater: <span class="stat-count" id="saltwaterCount">0</span></span>
        </div>
    </div>

    <!-- External scripts -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fish data -->
    <script src="./data/fish-data.js"></script>

    <!-- App -->
    <script>
        // ==========================================
        // Mapbox Access Token
        // ==========================================
        const MAPBOX_TOKEN = 'pk.eyJ1IjoidmFlc3poYW5nMTAyMiIsImEiOiJjbWs1bWZqbGUwMHZyM2RzN211YWk0dXNhIn0.tdZSR1H9VsEOfNuY4mJvTg';

        // ==========================================
        // Country name to ISO code mapping
        // ==========================================
        const countryToISO = {
            "Afghanistan": "AFG", "Albania": "ALB", "Algeria": "DZA", "Argentina": "ARG",
            "Australia": "AUS", "Austria": "AUT", "Bangladesh": "BGD", "Belgium": "BEL",
            "Bolivia": "BOL", "Brazil": "BRA", "Cambodia": "KHM", "Cameroon": "CMR",
            "Canada": "CAN", "Chile": "CHL", "China": "CHN", "Colombia": "COL",
            "Congo": "COG", "Costa Rica": "CRI", "Croatia": "HRV", "Cuba": "CUB",
            "Czech Republic": "CZE", "Denmark": "DNK", "Ecuador": "ECU", "Egypt": "EGY",
            "Ethiopia": "ETH", "Finland": "FIN", "France": "FRA", "Germany": "DEU",
            "Ghana": "GHA", "Greece": "GRC", "Guatemala": "GTM", "Honduras": "HND",
            "Hungary": "HUN", "Iceland": "ISL", "India": "IND", "Indonesia": "IDN",
            "Iran": "IRN", "Iraq": "IRQ", "Ireland": "IRL", "Israel": "ISR",
            "Italy": "ITA", "Jamaica": "JAM", "Japan": "JPN", "Kenya": "KEN",
            "North Korea": "PRK", "South Korea": "KOR", "Korea": "KOR",
            "Laos": "LAO", "Latvia": "LVA", "Lebanon": "LBN", "Libya": "LBY",
            "Lithuania": "LTU", "Madagascar": "MDG", "Malaysia": "MYS", "Mali": "MLI",
            "Mexico": "MEX", "Mongolia": "MNG", "Morocco": "MAR", "Mozambique": "MOZ",
            "Myanmar": "MMR", "Nepal": "NPL", "Netherlands": "NLD", "New Zealand": "NZL",
            "Nicaragua": "NIC", "Nigeria": "NGA", "Norway": "NOR", "Pakistan": "PAK",
            "Panama": "PAN", "Papua New Guinea": "PNG", "Paraguay": "PRY", "Peru": "PER",
            "Philippines": "PHL", "Poland": "POL", "Portugal": "PRT", "Romania": "ROU",
            "Russia": "RUS", "Saudi Arabia": "SAU", "Senegal": "SEN", "Singapore": "SGP",
            "Slovakia": "SVK", "Slovenia": "SVN", "Somalia": "SOM", "South Africa": "ZAF",
            "Spain": "ESP", "Sri Lanka": "LKA", "Sudan": "SDN", "Sweden": "SWE",
            "Switzerland": "CHE", "Syria": "SYR", "Taiwan": "TWN", "Tanzania": "TZA",
            "Thailand": "THA", "Tunisia": "TUN", "Turkey": "TUR", "Uganda": "UGA",
            "Ukraine": "UKR", "United Arab Emirates": "ARE", "UAE": "ARE",
            "United Kingdom": "GBR", "UK": "GBR", "England": "GBR", "Scotland": "GBR", "Wales": "GBR",
            "United States": "USA", "USA": "USA", "US": "USA", "America": "USA",
            "Uruguay": "URY", "Venezuela": "VEN", "Vietnam": "VNM", "Yemen": "YEM",
            "Zambia": "ZMB", "Zimbabwe": "ZWE",

            "People's Republic of China": "CHN",
            "People‚Äôs Republic of China": "CHN",
            "PRC": "CHN",
            "P.R.C.": "CHN",
            "Mainland China": "CHN",
            "China Mainland": "CHN",

            "Democratic Republic of the Congo": "COD", "DRC": "COD",
            "Republic of the Congo": "COG",
            "Central African Republic": "CAF",
            "South Sudan": "SSD",
            "Ivory Coast": "CIV", "Cote d'Ivoire": "CIV",
            "Burkina Faso": "BFA",
            "Sierra Leone": "SLE",
            "Liberia": "LBR",
            "Guinea": "GIN",
            "Guinea-Bissau": "GNB",
            "Gambia": "GMB",
            "Mauritania": "MRT",
            "Niger": "NER",
            "Chad": "TCD",
            "Eritrea": "ERI",
            "Djibouti": "DJI",
            "Botswana": "BWA",
            "Namibia": "NAM",
            "Lesotho": "LSO",
            "Swaziland": "SWZ", "Eswatini": "SWZ",
            "Malawi": "MWI",
            "Rwanda": "RWA",
            "Burundi": "BDI",
            "Gabon": "GAB",
            "Equatorial Guinea": "GNQ",
            "Benin": "BEN",
            "Togo": "TGO",
            "Angola": "AGO",
            "Dominican Republic": "DOM",
            "Haiti": "HTI",
            "Puerto Rico": "PRI",
            "Trinidad and Tobago": "TTO",
            "Bahamas": "BHS",
            "Belize": "BLZ",
            "El Salvador": "SLV",
            "Guyana": "GUY",
            "Suriname": "SUR",
            "French Guiana": "GUF",
            "Brunei": "BRN",
            "Timor-Leste": "TLS", "East Timor": "TLS",
            "Bhutan": "BTN",
            "Maldives": "MDV",
            "Cyprus": "CYP",
            "Estonia": "EST",
            "Luxembourg": "LUX",
            "Malta": "MLT",
            "Montenegro": "MNE",
            "North Macedonia": "MKD", "Macedonia": "MKD",
            "Serbia": "SRB",
            "Bosnia and Herzegovina": "BIH", "Bosnia": "BIH",
            "Kosovo": "XKX",
            "Moldova": "MDA",
            "Belarus": "BLR",
            "Georgia": "GEO",
            "Armenia": "ARM",
            "Azerbaijan": "AZE",
            "Kazakhstan": "KAZ",
            "Uzbekistan": "UZB",
            "Turkmenistan": "TKM",
            "Kyrgyzstan": "KGZ",
            "Tajikistan": "TJK",
            "Oman": "OMN",
            "Qatar": "QAT",
            "Bahrain": "BHR",
            "Kuwait": "KWT",
            "Jordan": "JOR",
            "Palestine": "PSE",
            "Fiji": "FJI",
            "Solomon Islands": "SLB",
            "Vanuatu": "VUT",
            "New Caledonia": "NCL",
            "Samoa": "WSM",
            "Tonga": "TON",

            "Hong Kong": "HKG",
            "Guam": "GUM",
            "Hawaii": "USA",
            "US Virgin Islands": "VIR", "Virgin Islands": "VIR",
            "Mauritius": "MUS"
        };

        // ==========================================
        // Application Variables
        // ==========================================
        let map = null;
        let geolocate = null;          // ‚úÖ Mapbox GeolocateControl
        let userLocationMarker = null; // (kept for compatibility)
        let currentFish = null;
        let currentFilter = 'all';
        let currentView = 'atlas';

        const sidePanel = document.getElementById('sidePanel');
        const overlay = document.getElementById('overlay');
        const panelClose = document.getElementById('panelClose');
        const fishNameEl = document.getElementById('fishName');
        const fishLatinEl = document.getElementById('fishLatin');
        const fishTypeBadge = document.getElementById('fishTypeBadge');
        const panelContent = document.getElementById('panelContent');
        const loading = document.getElementById('loading');

        const typeFilterBtns = document.querySelectorAll('#typeControls .filter-btn');
        const viewBtns = document.querySelectorAll('.filter-btn.view');

        const fishListPanel = document.querySelector('.fish-list-panel');
        const fishListContent = document.getElementById('fishListContent');
        const fishSearch = document.getElementById('fishSearch');
        const typeControls = document.getElementById('typeControls');

        const nearMePanel = document.getElementById('nearMePanel');
        const nearMeBody = document.getElementById('nearMeBody');
        const nearMeSubtitle = document.getElementById('nearMeSubtitle');
        const nearMeRefresh = document.getElementById('nearMeRefresh');
        const manualCountryInput = document.getElementById('manualCountryInput');
        const manualCountryApply = document.getElementById('manualCountryApply');

        // ==========================================
        // Helper Functions
        // ==========================================
        function showError(message, submessage) {
            loading.innerHTML = `
                <div class="error-message">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="text">${message}</div>
                    ${submessage ? `<div class="subtext">${submessage}</div>` : ''}
                </div>
            `;
        }

        // Normalize (handles smart quotes & extra spaces)
        function normalizeCountryName(s) {
            return (s || '')
                .trim()
                .toLowerCase()
                .replace(/[‚Äô‚Äò]/g, "'")
                .replace(/\s+/g, ' ');
        }

        function getCountryISO(countryName) {
            if (!countryName) return countryName;

            // direct hit
            if (countryToISO[countryName]) return countryToISO[countryName];

            // normalized hit (smart quotes, spaces, case)
            const key = normalizeCountryName(countryName);
            for (const [name, iso] of Object.entries(countryToISO)) {
                if (normalizeCountryName(name) === key) return iso;
            }

            // fallback: maybe already ISO3
            return countryName;
        }

        // Ensure map is ready before adding images/sources/layers
        function withMapReady(fn) {
            if (!map) return;
            if (map.loaded()) fn();
            else map.once('load', fn);
        }

        // ==========================================
        // Fish List Functions
        // ==========================================
        function renderFishList(filter = 'all', searchTerm = '') {
            const filtered = (window.fishData || []).filter(fish => {
                const matchesFilter = filter === 'all' || fish.type === filter;
                const matchesSearch = searchTerm === '' ||
                    fish.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    fish.latin.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesFilter && matchesSearch;
            });

            if (filtered.length === 0) {
                fishListContent.innerHTML = `
                    <div class="no-selection">
                        <div class="no-selection-icon">üîç</div>
                        <div class="no-selection-text">No fish found</div>
                    </div>
                `;
                return;
            }

            fishListContent.innerHTML = filtered.map(fish => `
                <div class="fish-item ${fish.type} ${currentFish && currentFish.id === fish.id ? 'active' : ''}"
                     data-id="${fish.id}">
                    <div class="fish-item-name">
                        <span class="fish-type-dot ${fish.type}"></span>
                        ${fish.name}
                    </div>
                    <div class="fish-item-latin">${fish.latin}</div>
                </div>
            `).join('');

            document.querySelectorAll('.fish-item').forEach(item => {
                item.addEventListener('click', () => {
                    const fishId = parseInt(item.dataset.id, 10);
                    const fish = (window.fishData || []).find(f => f.id === fishId);
                    if (fish) selectFish(fish);
                });
            });
        }

        function selectFish(fish) {
            currentFish = fish;

            document.querySelectorAll('.fish-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.id, 10) === fish.id) item.classList.add('active');
            });

            highlightCountries(fish);
            openPanel(fish);
        }

        // ==========================================
        // Map Functions
        // ==========================================
        function initMap() {
            if (typeof mapboxgl === 'undefined') {
                showError('Failed to load Mapbox GL JS', 'Please check your internet connection');
                return;
            }

            mapboxgl.accessToken = MAPBOX_TOKEN;

            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [20, 20],
                    zoom: 1.5,
                    projection: 'mercator'
                });

                map.on('style.load', () => {
                    map.setFog({
                        color: 'rgb(10, 22, 40)',
                        'high-color': 'rgb(26, 58, 92)',
                        'horizon-blend': 0.02
                    });
                });

                map.on('load', () => {
                    loading.style.display = 'none';

                    map.addSource('countries', {
                        type: 'vector',
                        url: 'mapbox://mapbox.country-boundaries-v1'
                    });

                    map.addLayer({
                        id: 'country-fills',
                        type: 'fill',
                        source: 'countries',
                        'source-layer': 'country_boundaries',
                        paint: { 'fill-color': '#3498db', 'fill-opacity': 0 }
                    }, 'country-label');

                    map.addLayer({
                        id: 'country-borders',
                        type: 'line',
                        source: 'countries',
                        'source-layer': 'country_boundaries',
                        paint: { 'line-color': '#ffffff', 'line-width': 0, 'line-opacity': 0.5 }
                    }, 'country-label');

                    // ‚úÖ Setup Mapbox GeolocateControl AFTER map is loaded
                    setupGeolocateControl();

                    renderFishList();
                    updateStats();
                });

                map.on('error', (e) => {
                    console.error('Mapbox error:', e);
                    showError('Map failed to load', e.error?.message || 'Check your access token');
                });

                map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
            } catch (error) {
                console.error('Map initialization error:', error);
                showError('Failed to initialize map', error.message);
            }
        }

        function setupGeolocateControl() {
            try {
                geolocate = new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 60000
                    },
                    trackUserLocation: false,
                    showUserHeading: true,
                    showAccuracyCircle: true
                });

                // Keep controls clustered; your NavigationControl already in bottom-right
                map.addControl(geolocate, 'bottom-right');

                geolocate.on('geolocate', async (e) => {
                    const lat = e.coords.latitude;
                    const lon = e.coords.longitude;

                    // pulsing dot + fly
                    withMapReady(() => {
                        try {
                            upsertUserLocationDot(lon, lat);
                            const z = map.getZoom();
                            map.flyTo({
                                center: [lon, lat],
                                zoom: 3,
                                speed: 0.9,
                                curve: 1.2,
                                essential: true
                            });
                        } catch (err) {
                            console.warn('Failed to add pulsing dot:', err);
                        }
                    });

                    try {
                        const countryName = await reverseGeocodeCountryName(lat, lon);
                        if (!countryName) {
                            setNearMeError('Country not found', 'Reverse geocoding returned no country.');
                            nearMeSubtitle.textContent = 'Unknown country';
                            return;
                        }

                        const iso3 = getCountryISO(countryName);
                        nearMeSubtitle.textContent = `${countryName} (${iso3})`;

                        highlightISO3s([iso3], '#f4e4c1', '#ffffff');

                        const localFish = getFishByISO3(iso3);
                        const weather = await fetchCurrentWeather(lat, lon);

                        renderNearMe(countryName, iso3, lat, lon, weather, localFish);
                    } catch (err) {
                        console.error(err);
                        setNearMeError('Failed', err.message || String(err));
                        nearMeSubtitle.textContent = 'Failed';
                    }
                });

                geolocate.on('error', (e) => {
                    console.error('GeolocateControl error:', e);
                    const msg = (e && e.message) ? e.message : 'Permission denied or timed out.';
                    setNearMeError('Location error', msg + ' You can type a country below as fallback.');
                    nearMeSubtitle.textContent = 'Location error';
                });
            } catch (e) {
                console.warn('Failed to setup GeolocateControl:', e);
            }
        }

        function highlightCountries(fish) {
            if (!map || !map.getLayer('country-fills')) return;

            const isoCodes = (fish.countries || []).map(c => getCountryISO(c));
            const fillColor = fish.type === 'freshwater' ? '#2ecc71' : '#3498db';
            const borderColor = fish.type === 'freshwater' ? '#27ae60' : '#2980b9';

            const inExpr = ['in', ['get', 'iso_3166_1_alpha_3'], ['literal', isoCodes]];

            map.setPaintProperty('country-fills', 'fill-color', fillColor);
            map.setPaintProperty('country-fills', 'fill-opacity', ['case', inExpr, 0.5, 0]);

            map.setPaintProperty('country-borders', 'line-color', borderColor);
            map.setPaintProperty('country-borders', 'line-width', ['case', inExpr, 2, 0]);
        }

        function highlightISO3s(isoCodes, fillColor = '#f4e4c1', borderColor = '#ffffff') {
            if (!map || !map.getLayer('country-fills')) return;
            const inExpr = ['in', ['get', 'iso_3166_1_alpha_3'], ['literal', isoCodes]];

            map.setPaintProperty('country-fills', 'fill-color', fillColor);
            map.setPaintProperty('country-fills', 'fill-opacity', ['case', inExpr, 0.35, 0]);

            map.setPaintProperty('country-borders', 'line-color', borderColor);
            map.setPaintProperty('country-borders', 'line-width', ['case', inExpr, 2, 0]);
        }

        // ===== Pulsing dot (your location) =====
        function createPulsingDot() {
            const size = 180;

            return {
                width: size,
                height: size,
                data: new Uint8Array(size * size * 4),

                onAdd: function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = this.width;
                    canvas.height = this.height;
                    this.context = canvas.getContext('2d');
                },

                render: function () {
                    const duration = 1200;
                    const t = (performance.now() % duration) / duration;

                    const ctx = this.context;
                    const center = size / 2;

                    const innerRadius = 12;
                    const outerRadius = innerRadius + 55 * t;

                    ctx.clearRect(0, 0, this.width, this.height);

                    // outer ring pulse
                    ctx.beginPath();
                    ctx.arc(center, center, outerRadius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(244, 228, 193, ${0.45 * (1 - t)})`;
                    ctx.fill();

                    // solid core
                    ctx.beginPath();
                    ctx.arc(center, center, innerRadius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(244, 228, 193, 1)`;
                    ctx.fill();

                    // outline
                    ctx.beginPath();
                    ctx.arc(center, center, innerRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255,255,255,0.9)`;
                    ctx.lineWidth = 3;
                    ctx.stroke();

                    this.data = ctx.getImageData(0, 0, this.width, this.height).data;

                    map && map.triggerRepaint();
                    return true;
                }
            };
        }

        function upsertUserLocationDot(lon, lat) {
            if (!map) return;

            // Add image (needs style loaded)
            if (!map.hasImage('pulsing-dot')) {
                map.addImage('pulsing-dot', createPulsingDot(), { pixelRatio: 2 });
            }

            const geojson = {
                type: 'FeatureCollection',
                features: [{
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [lon, lat] },
                    properties: {}
                }]
            };

            if (!map.getSource('user-location')) {
                map.addSource('user-location', { type: 'geojson', data: geojson });
                map.addLayer({
                    id: 'user-location-layer',
                    type: 'symbol',
                    source: 'user-location',
                    layout: {
                        'icon-image': 'pulsing-dot',
                        'icon-size': 1
                    }
                });
            } else {
                map.getSource('user-location').setData(geojson);
            }
        }

        function clearHighlights() {
            if (!map || !map.getLayer('country-fills')) return;
            map.setPaintProperty('country-fills', 'fill-opacity', 0);
            map.setPaintProperty('country-borders', 'line-width', 0);
        }

        // ==========================================
        // Image Modal
        // ==========================================
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        function openImageModal(src) { modalImage.src = src; imageModal.classList.add('active'); }
        function closeImageModal() { imageModal.classList.remove('active'); }
        imageModal.addEventListener('click', closeImageModal);

        function setupImageClicks() {
            document.querySelectorAll('.panel-content img').forEach(img => {
                img.addEventListener('click', () => openImageModal(img.src));
            });
        }

        // ==========================================
        // Panel Functions
        // ==========================================
        function openPanel(fish) {
            fishNameEl.textContent = fish.name;
            fishLatinEl.textContent = fish.latin;
            fishTypeBadge.textContent = fish.type === 'freshwater' ? 'Freshwater' : 'Saltwater';
            fishTypeBadge.className = `fish-type-badge ${fish.type}`;

            let content = '';
            if (typeof marked !== 'undefined') content = marked.parse(fish.markdown);
            else content = `<pre style="white-space: pre-wrap;">${fish.markdown}</pre>`;

            content += `
                <div class="distribution-info">
                    <div class="distribution-title">Distribution (${(fish.countries || []).length} countries)</div>
                    <div class="distribution-countries">
                        ${(fish.countries || []).map(c => `<span class="country-tag">${c}</span>`).join('')}
                    </div>
                </div>
            `;

            panelContent.innerHTML = content;
            setupImageClicks();

            sidePanel.classList.add('open');
            overlay.classList.add('active');
        }

        function closePanel() {
            sidePanel.classList.remove('open');
            overlay.classList.remove('active');
        }

        // ==========================================
        // Stats & Filter Functions
        // ==========================================
        function updateStats() {
            const freshwaterCount = (window.fishData || []).filter(f => f.type === 'freshwater').length;
            const saltwaterCount = (window.fishData || []).filter(f => f.type === 'saltwater').length;

            document.getElementById('freshwaterCount').textContent = freshwaterCount;
            document.getElementById('saltwaterCount').textContent = saltwaterCount;
        }

        // ==========================================
        // View Mode (Atlas / Near Me)
        // ==========================================
        function switchView(view) {
            currentView = view;

            viewBtns.forEach(b => b.classList.toggle('active', b.dataset.view === view));

            if (view === 'atlas') {
                nearMePanel.classList.remove('active');
                fishListPanel.style.display = '';
                typeControls.style.display = '';
                return;
            }

            fishListPanel.style.display = 'none';
            typeControls.style.display = 'none';
            nearMePanel.classList.add('active');
            startNearMe(); // ‚úÖ uses GeolocateControl
        }

        function setNearMeLoading(text = 'Detecting location‚Ä¶') {
            nearMeBody.innerHTML = `
                <div class="near-me-loading">
                    <div class="loading-spinner" style="width:32px;height:32px;"></div>
                    <div class="loading-text" style="font-size:0.8rem;">${text}</div>
                </div>
            `;
        }

        function setNearMeError(title, detail) {
            nearMeBody.innerHTML = `
                <div class="near-me-card">
                    <div style="font-family:'JetBrains Mono', monospace; letter-spacing:0.08em; text-transform:uppercase; opacity:0.9; font-size:0.75rem;">‚ö†Ô∏è ${title}</div>
                    <div style="margin-top:0.6rem; line-height:1.6; opacity:0.85;">${detail || ''}</div>
                </div>
            `;
        }

        async function reverseGeocodeCountryName(lat, lon) {
            const url =
                `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json` +
                `?types=country&language=en&access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`Mapbox geocoding failed: ${res.status}`);
            const data = await res.json();

            const feature = (data.features || []).find(f => (f.place_type || []).includes('country'));
            return feature?.text || null;
        }

        function getFishByISO3(iso3) {
            return (window.fishData || []).filter(f =>
                (f.countries || []).some(c => getCountryISO(c) === iso3)
            );
        }

        async function fetchCurrentWeather(lat, lon) {
            const url =
                `https://api.open-meteo.com/v1/forecast` +
                `?latitude=${encodeURIComponent(lat)}` +
                `&longitude=${encodeURIComponent(lon)}` +
                `&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m` +
                `&timezone=auto`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`Weather fetch failed: ${res.status}`);
            const data = await res.json();
            return data.current || null;
        }

        function weatherCodeToText(code) {
            const m = {
                0:{t:'Clear',e:'‚òÄÔ∏è'}, 1:{t:'Mainly clear',e:'üå§Ô∏è'}, 2:{t:'Partly cloudy',e:'‚õÖ'}, 3:{t:'Overcast',e:'‚òÅÔ∏è'},
                45:{t:'Fog',e:'üå´Ô∏è'}, 48:{t:'Rime fog',e:'üå´Ô∏è'},
                51:{t:'Light drizzle',e:'üå¶Ô∏è'}, 53:{t:'Drizzle',e:'üå¶Ô∏è'}, 55:{t:'Dense drizzle',e:'üåßÔ∏è'},
                61:{t:'Light rain',e:'üåßÔ∏è'}, 63:{t:'Rain',e:'üåßÔ∏è'}, 65:{t:'Heavy rain',e:'üåßÔ∏è'},
                71:{t:'Light snow',e:'üå®Ô∏è'}, 73:{t:'Snow',e:'üå®Ô∏è'}, 75:{t:'Heavy snow',e:'‚ùÑÔ∏è'},
                80:{t:'Rain showers',e:'üå¶Ô∏è'}, 81:{t:'Heavy showers',e:'üåßÔ∏è'}, 82:{t:'Violent showers',e:'‚õàÔ∏è'},
                95:{t:'Thunderstorm',e:'‚õàÔ∏è'}, 96:{t:'Thunderstorm + hail',e:'‚õàÔ∏è'}, 99:{t:'Thunderstorm + hail',e:'‚õàÔ∏è'}
            };
            return m[code] || { t: `Weather code ${code}`, e: 'üå°Ô∏è' };
        }

        function renderNearMe(countryName, iso3, lat, lon, weather, localFish) {
            const weatherPart = (() => {
                if (!weather) {
                    return `
                        <div class="near-me-section-title">Weather</div>
                        <div class="near-me-card">Weather unavailable (try refreshing or allow location).</div>
                    `;
                }
                const w = weatherCodeToText(weather.weather_code);
                const temp = Math.round(weather.temperature_2m);
                const feels = Math.round(weather.apparent_temperature);
                const wind = Math.round(weather.wind_speed_10m);

                return `
                    <div class="near-me-section-title">Weather</div>
                    <div class="near-me-card">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:0.75rem;">
                            <div style="font-size:1.1rem; font-weight:800; color:var(--sand);">${w.e} ${w.t}</div>
                            <div style="font-family:'JetBrains Mono', monospace; opacity:0.7; font-size:0.75rem;">
                                ${lat.toFixed(2)}, ${lon.toFixed(2)}
                            </div>
                        </div>
                        <div class="near-me-grid" style="margin-top:0.8rem;">
                            <div class="near-me-kv">
                                <div class="near-me-k">Temp</div>
                                <div class="near-me-v">${temp}¬∞C</div>
                            </div>
                            <div class="near-me-kv">
                                <div class="near-me-k">Feels like</div>
                                <div class="near-me-v">${feels}¬∞C</div>
                            </div>
                            <div class="near-me-kv">
                                <div class="near-me-k">Wind</div>
                                <div class="near-me-v">${wind} km/h</div>
                            </div>
                            <div class="near-me-kv">
                                <div class="near-me-k">Country</div>
                                <div class="near-me-v" style="font-size:0.95rem;">${countryName}</div>
                            </div>
                        </div>
                    </div>
                `;
            })();

            const fishPart = (() => {
                const count = localFish.length;
                if (count === 0) {
                    return `
                        <div class="near-me-section-title">Species in your country</div>
                        <div class="near-me-card" style="opacity:0.9; line-height:1.6;">
                            No species from <b>${countryName}</b> found in <code>fishData</code>.
                            <br/>Tip: check country naming in <code>fish.countries</code>.
                        </div>
                    `;
                }

                return `
                    <div class="near-me-section-title">Species in your country (${count})</div>
                    <div class="near-me-fish-list">
                        ${localFish.map(f => `
                            <div class="near-me-fish-item" data-fish-id="${f.id}">
                                <div class="near-me-fish-name">
                                    <span class="near-me-pill ${f.type}">${f.type}</span>
                                    ${f.name}
                                </div>
                                <div class="near-me-fish-latin">${f.latin}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            })();

            nearMeBody.innerHTML = weatherPart + fishPart;

            nearMeBody.querySelectorAll('.near-me-fish-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = parseInt(el.dataset.fishId, 10);
                    const fish = (window.fishData || []).find(f => f.id === id);
                    if (fish) selectFish(fish);
                });
            });
        }

        // ‚úÖ Near Me: Use Mapbox GeolocateControl (preferred), fallback to navigator.geolocation
        function startNearMe() {
            setNearMeLoading('Locating‚Ä¶');
            nearMeSubtitle.textContent = 'Locating‚Ä¶';

            if (!map) {
                setNearMeError('Map not ready', 'Map is not initialized yet.');
                nearMeSubtitle.textContent = 'Map not ready';
                return;
            }

            // Prefer Mapbox geolocate
            if (geolocate && typeof geolocate.trigger === 'function') {
                withMapReady(() => {
                    try {
                        geolocate.trigger(); // will fire "geolocate" event
                    } catch (err) {
                        console.error(err);
                        setNearMeError('Location error', 'Failed to trigger geolocation. You can type a country below as fallback.');
                        nearMeSubtitle.textContent = 'Location error';
                    }
                });
                return;
            }

            // Fallback
            if (!navigator.geolocation) {
                setNearMeError('Geolocation unavailable', 'Your browser does not support geolocation.');
                nearMeSubtitle.textContent = 'Location unavailable';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    withMapReady(() => {
                        try {
                            upsertUserLocationDot(lon, lat);
                            const z = map.getZoom();
                            map.flyTo({ center: [lon, lat], zoom: Math.max(z, 4), essential: true });
                        } catch (e) {
                            console.warn('Failed to add pulsing dot:', e);
                        }
                    });

                    try {
                        const countryName = await reverseGeocodeCountryName(lat, lon);
                        if (!countryName) throw new Error('Reverse geocoding returned no country');

                        const iso3 = getCountryISO(countryName);
                        nearMeSubtitle.textContent = `${countryName} (${iso3})`;

                        highlightISO3s([iso3], '#f4e4c1', '#ffffff');

                        const localFish = getFishByISO3(iso3);
                        const weather = await fetchCurrentWeather(lat, lon);

                        renderNearMe(countryName, iso3, lat, lon, weather, localFish);
                    } catch (err) {
                        console.error(err);
                        setNearMeError('Failed', err.message || String(err));
                        nearMeSubtitle.textContent = 'Failed';
                    }
                },
                (err) => {
                    console.error(err);
                    let msg = 'Permission denied or timed out.';
                    if (err && err.code === 1) msg = 'You denied location permission.';
                    if (err && err.code === 2) msg = 'Position unavailable.';
                    if (err && err.code === 3) msg = 'Location request timed out.';
                    setNearMeError('Location error', msg + ' You can type a country below as fallback.');
                    nearMeSubtitle.textContent = 'Location error';
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 60000 }
            );
        }

        // ==========================================
        // Event Listeners
        // ==========================================
        panelClose.addEventListener('click', closePanel);
        overlay.addEventListener('click', closePanel);

        // Type filters (All/Fresh/Salt)
        typeFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                typeFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderFishList(currentFilter, fishSearch.value);
            });
        });

        fishSearch.addEventListener('input', (e) => {
            renderFishList(currentFilter, e.target.value);
        });

        // View buttons (Atlas/Near Me)
        viewBtns.forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        nearMeRefresh.addEventListener('click', () => {
            if (currentView === 'nearby') startNearMe();
        });

        manualCountryApply.addEventListener('click', () => {
            const countryName = (manualCountryInput.value || '').trim();
            if (!countryName) return;

            const iso3 = getCountryISO(countryName);
            nearMeSubtitle.textContent = `${countryName} (${iso3})`;
            highlightISO3s([iso3], '#f4e4c1', '#ffffff');

            const localFish = getFishByISO3(iso3);
            renderNearMe(countryName, iso3, 0, 0, null, localFish);
        });

        // Nice: enter key to apply manual country
        manualCountryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') manualCountryApply.click();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePanel();
                closeImageModal();
            }
        });

        // ==========================================
        // Initialize
        // ==========================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }
    </script>
</body>
</html>